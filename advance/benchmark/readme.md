

# benchmark 测试入门

测试以 Benchmark 为方法开头
运行测试的时候，形如普通的测试，但是需要加上 -bench 选项

运行选项



# 内存和 CPU 分析

- google pprof 工具


1. 使用 pprof 工具来分析：go get -u github.com/google/pprof
2. 安装 graphviz
3. web 界面：pprof -http=:8080 cpu.out 


调用链路

1. 中间标红的就是关键路径，或者说瓶颈所在的路径
2. 在一般的企业级应用中，这条路径都是因为内存分配引起的
3. 除了关键路径，一些开销比较大的分支也要关心
4. 优化关键路径性价比最高（可以做到数量级提升）。但是有时候关键路径优化不动，那么可以尝试优化其它分支路径。


火焰图
    长度代表的就是资源消耗占比


其它，基本用不上



# Go 内存逃逸分析

在 Go 里面，对象可以被分配到栈或者堆上。分配到堆上的，被称为内存逃逸。

可能的原因（不是必然引起逃逸，而是可能逃逸。是否逃逸还跟执行上下文有关）：

    - 指针逃逸：如方法返回局部变量指针
    - interface{} 逃逸：如使用 interface{} 作为参数或者返回值
    - 接口逃逸：如以接口作为返回值
    - 大对象：大对象会直接分配到堆上
    - 栈空间不足
    - 闭包：闭包内部引用了外部变量
    - channel 传递指针

一般可以使用 -gcflags=-m 来分析内存逃逸

```shell
$ go build -gcflags '-m -l' escape.go 

```