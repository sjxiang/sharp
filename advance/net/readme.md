
# 网络编程

    - 入门
    - 连接池设计



# 1. 网络编程入门


## net 包

net 包是网络相关的核心包。net 里面包含了 http、rpc 等关键包。

在 net 里面，最重要的两个调用：

- Listen(network, addr string)：监听某个端口，等待客户端连接
- Dial(network, addr string)：拨号，其实也就是连接上某个服务器



## 通信基本流程

基本分成两个大阶段

1. 创建连接阶段
服务端开始监听一个端口
客户端拨通服务端，两者协商创建连接（TCP）

2. 通信阶段
客户端不断发送请求
服务端读取请求
服务端处理请求
服务端写回响应


client                 Server
    |                   |
    |                   | Listen
    ------- Dial ------>
    |                   | Accept
    |                   |
    <------- OK --------

     
循环/
  /
    |    Request        |
    +------------------>
    |                   | Read
    |                   | Handle
    |                   | Write
     <------------------+
    |     Response      |




## net.Listen

- Listen 是监听一个端口，准备读取数据。它还有几个类似接口，可以直接使用。
一般用 Listen 就可以，除非你要依赖于具体的网络协议特性。

- 网络通信用 TCP 还是用 UDP 是一个影响巨大的事情，一般确认了就不会改。



## 处理连接
    
处理连接基本上就是在一个 for 循环内：

- 先读数据：读数据要根据上层协议来决定怎么读。
例如，简单的 RFC 协议一般是分成两段读，先读头部，根据头部得知 Body 有多长，再把剩下的数据读出来。

- 处理数据

- 回写响应：即使处理数据出错，也要返回一个错误给客户端，不然客户端不知道你处理出错了。



## 错误处理

- 在读写的时候，都可能遇到错误。
一般来说代表连接已经关掉的是这三个：EOF、ErrUnexpectedEOF 和 ErrClosed

- 但是，建议只要是出错了就直接关闭，这样对客户端和服务端代码都简单。



## net.Dial

- net.Dial 是指创建一个连接，连上远端的服务器。
也有几个类似的方法，DialTimeout 稍微特殊一点，多了一个超时参数。

- 类似于 Listen，也是建议大家直接使用 DialTimeout ，因为设置超时可以避免一直阻塞。



## goroutine 问题

前面的模板，是在创建了连接之后，就交给另外一个 goroutine 去处理，除了这个位置，还有两个位置：

- 在读取了请求之后，交给别的 goroutine 处理，当前的 goroutine 继续读请求。
- 写响应的时候，交给别的 goroutine 去写


总之

- 为了 TCP 通信效率高
- 相应，系统复杂度提高





# 2. 连接池


在前面的示例代码中，客户端创建的连接都是一次性使用。然而，创建一个连接时非常昂贵的：

- 要发起系统调用
- TCP 要三次握手
- 高并发的情况下，可能耗尽文件描述符


连接池就是为了复用这些创建好的连接



## 连接池处理流程


Get 要考虑
- 有空闲连接，直接返回
- 否则，没超过最大连接数，直接创建新的
- 否则，阻塞调用方
 
Put 要考虑
- 有 Get 请求被阻塞，把连接丢过去
- 否则，没超过最大空闲连接数，放到空闲列表
- 否则，直接关闭




空闲连接队列
阻塞请求队列



参考： pool.jpg 示意图


1. 起步
    - 刚开始啥都没有，直接创建 1 个 GET 连接

2. 超过上限
    - 假如我们不断请求，直到超过 10 个请求。
    - 接下来，GET 请求被阻塞

3. 放回去，有阻塞请求
    - 如果说这时候有人用完了 PUT 连接，就放回来了。
    - 唤醒一个 GET 请求，然后将连接交过去。

4. 放回去空闲连接队列
    - 如果这个时候没有阻塞 GET 请求，并且此时空闲连接队列还没有满，那么就放回空闲连接队列

5. 空闲连接队列满了
    - 空闲连接队列满了，只能关掉这个 PUT 连接

6. 从空闲连接队列 GET
    - 空闲队列有可用连接，直接拿




连接池
    3 个参数：初始连接、最大空闲连接、最大连接数（过大，浪费；过小，突发流量应付不过来）

    运作原理：拿连接会发生什么、放回去又会发生什么

    过期时间处理
        1. 超时取消
            time.After 不行（肯定执行，万一我还在用，直接 ban 了怎么搞）
            Context （就返回个错误，还能接受）

        2. 定期

        sql.DB 解决过期连接的懒惰策略：类比缓存


